---

- name: Installer le transport HTTPS pour APT
  apt: name=apt-transport-https state=present
  sudo: yes

- name: Installer la clé du repo docker
  apt_key: keyserver=p80.pool.sks-keyservers.net id=58118E89F3A912897C070ADBF76221572C52609D
  sudo: yes

- name: Ajout repository APT Docker
  apt_repository: repo='deb https://apt.dockerproject.org/repo debian-jessie main' state=present
  sudo: yes
  
- name: Desinstaller docker.io
  apt: name=docker.io state=absent
  sudo: yes
  tags:
    - fix

- name: Installer les paquets nécessaires pour Docker
  apt: name={{ item }} state={{docker_package_state}}
  with_items:
    - docker-engine
    - openvswitch-switch
    - bridge-utils
  sudo: yes

- name: Create bridge
  script: create-bridge.sh docker0 br0 {{docker_interface_address}} {{docker_mtu}}
  sudo: yes
  notify:
    - restart docker

- name: Ajouter le script de contrôle de Docker
  copy: src=consul/check_docker.sh dest=/etc/consul/ mode=0700
  sudo: yes
  
- name: Ajouter la config du service Consul pour Docker
  copy: src=consul/service_docker.json dest=/etc/consul/
  sudo: yes
  notify:
    - restart consul
  
- name: Configurer le deamon Docker
  template: src=docker.service.j2 dest=/lib/systemd/system/docker.service
  sudo: yes
  notify:
    - restart docker
  
- name: "Supprimer l'ancien fichier de conf du daemon Docker, non utilisé"
  file: name={{ item }} state=absent
  sudo: yes
  with_items:
    - /etc/systemd/system/docker.service
    - /etc/default/docker
  tags:
    - fix

- name: Relance system
  command: systemctl daemon-reload
  sudo: true
  
  # systemctl est vraiment une grosse merde, impossible de l'utiliser en handler a cause de la pause...
- name: Attendre un peu avant la relance de systemctl
  pause: seconds=5
  
- name: "Flusher les handlers éventuellement activés, comme le restart de docker"
  meta: flush_handlers
  
- name: S'assurer que Docker est bien lancé avant de démarrer des containers (comme Docker UI)
  service: name=docker state=started
  sudo: yes

- name: Install pip
  easy_install: name=pip
  sudo: yes

- name: Install Docker Python API
  pip: name=docker-py state=present
  sudo: yes

- name: Lancer Docker UI
  docker:
    name: dockerui
    image: dockerui/dockerui
    privileged: yes
    ports: "9000:9000"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    docker_api_version: 1.18
  sudo: yes
